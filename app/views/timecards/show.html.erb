<% provide(:title, '勤怠情報')%>
<% provide(:arrival_time, '出社') %>
<% provide(:leaving_time, '退社') %>

<div class="work">
    
    <table id="work1" class="table-bordered table-striped">
        <tr>
            <td><span id="prev_month"><%= link_to '←', timecard_path(month: @this_month<<1) %></span><%= @this_month.strftime("%Y年%m月") %> 時間管理表<span id="next_month"><%= link_to '→', timecard_path(month: @this_month>>1) %></span></td>
            <td>所定勤務時間 <%= @admin_user.specifed_time.strftime("%H:%M") %></td>
            <td colspan="2">基本時間 <%= @admin_user.basic_time.strftime("%H:%M") %></td>
            <td>初日 <%=@this_month.beginning_of_month.strftime("%m/%d") %></td>
        </tr>
         <tr>
            <td>所属 <%= @user.department %></td>
            <td>名前 <%= @user.name %></td>
            <td>コード </td>
            <td>出勤日数 <%= @arrival_count %></td>
            <td>締め <%=@this_month.end_of_month.strftime("%m/%d") %></td>
        </tr>

    </table>    
    
    <%= link_to "勤怠を編集", edit_timecard_path(@user,month:@this_month), class: 'btn btn-success'%>
        
     <table id="work2" class="table-bordered table-striped">
        <tr>
            <th rowspan="2">日付</th>
            <th rowspan="2">曜日</th>
            <th colspan="3">出社 </th>
            <th colspan="3">退社 </th>
            <th rowspan="2">在社時間 </th>
            <th rowspan="2">備考 </th>
        </tr>
        <tr>
            <th>時</th>
            <th>分</th>
            <th class="time_btn"></th>
            <th>時</th>
            <th>分</th>
            <th class="time_btn"></th>
        </tr>
    
         <!-- 指定された月の日をインデックスと一緒にループする　!-->
        <% (@this_month.beginning_of_month..@this_month.end_of_month).each_with_index do |date,index| %>
            <tr>
            　　<td><%= date.strftime("%m/%d")%> </td>
                <td><%= %w(日 月 火 水 木 金 土)[date.wday]%></td>
                <!-- @time_cardsの配列の中でnilでなかった場合　!-->
                <% if(@time_cards[index]) %>
                    <td><%= @time_cards[index].arrival_time.strftime("%H") %></td>
                    <td><%= @time_cards[index].arrival_time.strftime("%M") %></td>
                    <td></td>
                    <!-- @time_cardsの配列の中で退社時間が登録されていたら　!-->
                    <% if(@time_cards[index]).leaving_time %>
                        <td><%= @time_cards[index].leaving_time.strftime("%H") %></td>
                        <td><%= @time_cards[index].leaving_time.strftime("%M") %></td>
                        <td></td>
                        <td><%= time_diff_str(@time_cards[index].leaving_time, @time_cards[index].arrival_time)%></td>
                    <!-- @time_cardsの配列の中で退社時間が登録されていなかったら　!-->    
                    <% else %> 
                        <td></td>
                        <td></td>
                        <!-- 本日の日付だったら退社時間を登録　!-->
                        <% if(date == Time.current.strftime("%Y-%m-%d").to_date) %>
                        <td>
                            <%= form_for(@timecard,url:leavingupdate_path) do |f| %>
                                <%= hidden_field_tag :id, @user.id %>
                                <%= f.submit yield(:leaving_time), name:"leaving_time", class: "btn btn-primary" %>
                            <% end %>
                        </td>   
                        <% end %>  
                        <td></td>
                    <% end %> 
                    <td></td>
               <% else %>
                    <td></td>
                    <td></td>
                    <!-- 本日の日付だったら退社時間を登録　!-->
                    <% if(date == Time.current.strftime("%Y-%m-%d").to_date) %>
                    <td>
                        <%= form_for @timecard do |f| %>
                            <%= hidden_field_tag :id, @user.id %>
                            <%= f.submit yield(:arrival_time), name:"arrival_time", class: "btn btn-primary" %>
                        <% end %>
                    </td>
                    <% end %>
                    <td></td>
                    <td></td>
                    <td></td> 
                    <td></td>
                    <td></td>
                    <td></td>
                <% end %>
             </tr> 
        <% end %>
        
         <tr>
             <td colspan="2"><%= total_basictime_str(@admin_user.basic_time,@time_cards)%></td>
             <td colspan="6"></td>
             <td><%= total_worktime_str(@time_cards)%></td>
             <td></td>
      </table>

</div>